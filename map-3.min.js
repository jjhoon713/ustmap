mapImgVersion="2";function readTextFile(b){var c=new XMLHttpRequest();var d;c.open("GET",b,false);c.onreadystatechange=function(){if(c.readyState===4){if(c.status===200||c.status==0){d=c.responseText}}};c.send(null);return d}function getBuildingNames(){var b=["Academic Building","CYT","IAS","LSK","Univ. Center","Campus"];return b}function getFloorIds(){return["LG7","LG5","LG4","LG3","LG1","G","1","2","3","4","5","6","7","CYTG","CYTUG","CYT1","CYT2","CYT3","CYT4","CYT5","CYT6","CYT7","IASG","IAS1","IAS2","IAS3","IAS4","IAS5","NABG","NAB1","NAB2","NAB3","NAB4","NAB5","NAB6","NAB7","UCG","UC1","Overall"]}function getFloorIdsOfBuilding(b){if(b==0){return["LG7","LG5","LG4","LG3","LG1","G","1","2","3","4","5","6","7"]}else{if(b==1){return["CYTG","CYTUG","CYT1","CYT2","CYT3","CYT4","CYT5","CYT6","CYT7"]}else{if(b==2){return["IASG","IAS1","IAS2","IAS3","IAS4","IAS5"]}else{if(b==3){return["NABG","NAB1","NAB2","NAB3","NAB4","NAB5","NAB6","NAB7"]}else{if(b==4){return["UCG","UC1"]}else{if(b==5){return["Overall"]}}}}}}}function idToInfos(b){if(b.includes("Overall")){buildingNo=5;floorNo=0}else{if(b.includes("CYT")){buildingNo=1;floorNo=getFloorIdsOfBuilding(1).indexOf(b)}else{if(b.includes("IAS")){buildingNo=2;floorNo=getFloorIdsOfBuilding(2).indexOf(b)}else{if(b.includes("NAB")){buildingNo=3;floorNo=getFloorIdsOfBuilding(3).indexOf(b)}else{if(b.includes("UC")){buildingNo=4;floorNo=getFloorIdsOfBuilding(4).indexOf(b)}else{buildingNo=0;floorNo=getFloorIdsOfBuilding(0).indexOf(b)}}}}}return{buildingNo:buildingNo,floorNo:floorNo}}function getFloorNames(b){if(b==0){return["LG7","LG5","LG4","LG3","LG1","G","1","2","3","4","5","6","7"]}else{if(b==1){return["G","UG","1","2","3","4","5","6","7"]}else{if(b==2){return["G","1","2","3","4","5"]}else{if(b==3){return["G","1","2","3","4","5","6","7"]}else{if(b==4){return["G","1"]}else{if(b==5){return["Overall"]}}}}}}}function changeBuilding(c){document.getElementById("building_btn").innerHTML=getBuildingNames()[c];floor=document.getElementById("floor_dropdown");while(floor.hasChildNodes()){floor.removeChild(floor.lastChild)}floors=getFloorNames(c);for(i=0;i<floors.length;i++){li=document.createElement("li");a=document.createElement("a");var b=document.createTextNode(floors[i]);a.appendChild(b);li.appendChild(a);floor.appendChild(li);li.setAttribute("onclick","changeFloor("+c+","+i+");")}document.getElementById("floor_btn").innerHTML=floors[0];map.setCenter({lat:initLat,lng:initLng});map.setZoom(initZoom);return changeFloor(c,0)}var markers=[];function changeFloor(d,b){if(onlyMarker!=null){onlyMarker.setMap(null)}floors=getFloorNames(d);document.getElementById("floor_btn").innerHTML=floors[b];changeMap(d,b);text=readTextFile("data/"+d+b).split("\n");lat_weight=parseFloat(text[0]);lat_bias=parseFloat(text[1]);lon_weight=parseFloat(text[2]);lon_bias=parseFloat(text[3]);for(var c=0;c<markers.length;c++){markers[c].setMap(null)}markers=[];$.ajax({type:"GET",url:"http://jchungaa.student.ust.hk/ustmap/getdataproxy.php?floor="+getFloorIdsOfBuilding(d)[b],xhr:function(){return xhr}}).done(function(e){text=e.split("\n");for(c=0;c<text.length;c++){elem=text[c].split(";");if(elem.length<3){continue}number=elem[5];name=elem[1];if(name.substr(0,4).toLowerCase()=="room"){name=name.substr(4)}if(name=="null"){continue}typ=elem[2];x=parseFloat(elem[0].split(",")[0]);y=parseFloat(elem[0].split(",")[1]);page=elem[4];donno=elem[3];lat=y*lat_weight+lat_bias;lon=x*lon_weight+lon_bias;zIndex=0;if(typ.toLowerCase().includes("stair")||name.substr(0,5)=="stair"){label="";icon="img/ic_stairs.png"}else{if(typ.toLowerCase().includes("female")){label="";icon="img/ic_ftoilet.png"}else{if(typ.toLowerCase().includes("male")){label="";icon="img/ic_mtoilet.png"}else{if(typ.toLowerCase().includes("atm")){label="";icon="img/ic_atm.png"}else{if(typ.toLowerCase().includes("cross")){label="";icon="img/ic_crossconnector.png"}else{if(typ.toLowerCase().includes("fountain")){label="";icon="img/ic_drinking.png"}else{if(typ.toLowerCase().includes("escalator")||name.substr(0,9)=="ESCALATOR"){label="";icon="img/ic_escalator.png"}else{if(typ.toLowerCase().includes("express")||typ.toLowerCase().includes("virtual")){label="";icon="img/ic_express.png"}else{if(name.substr(0,4)=="LIFT"){label=name.toLowerCase().replace("lift","");icon="img/ic_lift_bg.png";zIndex=500*parseInt(label)}else{if(typ.toLowerCase().includes("mail")){label="";icon="img/ic_mailbox.png"}else{if(typ.toLowerCase().includes("restaurant")){label="";icon="img/ic_restaurant.png"}else{if(typ.toLowerCase().includes("satellite printer")){label="";icon="img/ic_printer.png"}else{label=name.replace(/ /g,"\n");icon=" "}}}}}}}}}}}}if(icon==" "){newMarker=new MapLabel({text:label,position:new google.maps.LatLng(lat,lon),map:map,fontSize:30,align:"center",strokeWeight:8})}else{newMarker=new google.maps.Marker({position:{lat:lat,lng:lon},clickable:false,cursor:"123",label:label,icon:{url:icon,scaledSize:new google.maps.Size(20,20),size:new google.maps.Size(60,60),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(10,10),labelOrigin:new google.maps.Point(10,10)},map:null,title:name,zIndex:zIndex})}markers.push(newMarker)}setMarkers()});return{latW:lat_weight,latB:lat_bias,lonW:lon_weight,lonB:lon_bias}}function initBuildingDropdowns(){building=document.getElementById("building_dropdown");while(building.hasChildNodes()){building.removeChild(building.lastChild)}buildings=getBuildingNames();for(i=0;i<buildings.length;i++){li=document.createElement("li");a=document.createElement("a");linkText=document.createTextNode(buildings[i]);a.appendChild(linkText);li.appendChild(a);building.appendChild(li);li.setAttribute("onclick","changeBuilding("+i+");")}document.getElementById("building_btn").innerHTML=buildings[0]}function returnXtimesTwoSquareY(b,c){if(c>=0){return b*parseInt(Math.pow(2,c))}else{return b/parseInt(Math.pow(2,-c))}}function getSrc(b,f,e,h){var g=6;var d=16;var c=32;return""+b+"/"+f+"/tile_"+parseInt(e-g)+"_"+(h.x-returnXtimesTwoSquareY(d,e-g))+"-"+(h.y-returnXtimesTwoSquareY(c,e-g))+".png?"+mapImgVersion}function changeMap(b,c){map.setMapTypeId(b+""+c)}function hideAllMarkers(d,c){if(c==null){return}cnt=0;if(d){for(var b=0;b<markers.length;b++){if(!(markers[b].getIcon().url.includes("lift")||markers[b].getIcon().url.includes("toilet"))){markers[b].setMap(null)}else{if(markers[b].getMap()==null){markers[b].setMap(map)}}}}else{for(var b=0;b<markers.length;b++){markerPos=markers[b].getPosition();if(c.contains(markerPos)){cnt=cnt+1;if(markers[b].getMap()==null){markers[b].setMap(map)}}else{markers[b].setMap(null)}}}}function searchFocusIn(){document.getElementById("search_card").style.visibility="visible"}function searchFocusOut(){document.getElementById("search_card").style.visibility="hidden"}function goToPin(e,b,f,d){saveCookie(d);changeBuilding(idToInfos(e).buildingNo);var c=changeFloor(idToInfos(e).buildingNo,idToInfos(e).floorNo);lat=f*c.latW+c.latB;lon=b*c.lonW+c.lonB;map.setCenter({lat:lat,lng:lon});map.setZoom(8);searchFocusOut();addMarker({lat:lat,lng:lon},map)}var onlyMarker;function addMarker(b,c){if(onlyMarker!=null){onlyMarker.setMap(null)}marker=new google.maps.Marker({position:b,label:"",map:c,optimized:false,zIndex:99999999,icon:{url:"img/ic_here.png",size:new google.maps.Size(48,48),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(24,24),labelOrigin:new google.maps.Point(24,24)}});marker.addListener("click",function(){marker.setMap(null)});onlyMarker=marker}function isCardEmpty(){text=document.getElementById("search").value;cardIsEmpty(text.length==0)}function searchChange(){xhr.abort();text=document.getElementById("search").value;cardIsEmpty(text.length==0);pgbar=document.getElementById("pgbar");pgbar.hidden=false;if(text.length==0){pgbar.hidden=true;return}var c=document.getElementById("search_results");while(c.firstChild){c.removeChild(c.firstChild)}if(text.length!=0){var b=$.ajax({type:"GET",url:"http://jchungaa.student.ust.hk/ustmap/searchproxy.php?keyword="+text,xhr:function(){return xhr}}).done(function(d){cnt=0;d.split("\n").forEach(function(e){msges=e.split(";");if(e.length==0){return}if(msges.length<2){return}if(cnt>4){return}cnt=cnt+1;one=document.createElement("div");one.classList.add("col");one.classList.add("s12");two=document.createElement("a");abc=1;two.setAttribute("onclick","goToPin('"+msges[3]+"',"+msges[2]+",`"+e+"`);");two.classList.add("valign-wrapper");threeone=document.createElement("div");threeone.classList.add("col");threeone.classList.add("s1");threeone.classList.add("center-align");threeone.style="padding:0px";threetwo=document.createElement("div");threetwo.innerHTML=getBuildingNames()[idToInfos(msges[3]).buildingNo];threetwo.style="line-height: 1.1";threetwo.classList.add("col");threetwo.classList.add("s5");threetwo.classList.add("center-align");threethree=document.createElement("div");threethree.style="line-height: 1.1";threethree.classList.add("col");threethree.classList.add("s6");threethree.innerHTML=msges[0];icon=document.createElement("i");icon.classList.add("material-icons");icon.innerHTML="location_on";threeone.appendChild(icon);two.appendChild(threeone);two.appendChild(threetwo);two.appendChild(threethree);one.appendChild(two);document.getElementById("search_results").appendChild(one)});if(cnt==0){document.getElementById("search_results").innerHTML="There are no result with "+text}pgbar.hidden=true})}else{pgbar.hidden=true}}function saveCookie(b){till=4;for(i=0;i<4;i++){if(Cookies.get("room"+i)==b){till=i;break}}for(i=till;i>0;i--){Cookies.set("room"+i,Cookies.get("room"+(i-1)))}Cookies.set("room"+0,b)}function cardIsEmpty(b){if(b){if(Cookies.get("room0")==null||Cookies.get("room0")=="undefined"){document.getElementById("empty_card").style.display="block";document.getElementById("searches").style.display="none";document.getElementById("historys").style.display="none"}else{document.getElementById("searches").style.display="none";document.getElementById("empty_card").style.display="none";document.getElementById("historys").style.display="inline";showHistory()}}else{document.getElementById("searches").style.display="inline";document.getElementById("empty_card").style.display="none";document.getElementById("historys").style.display="none"}}function showHistory(){var b=document.getElementById("history_results");while(b.firstChild){b.removeChild(b.firstChild)}for(i=0;i<5;i++){entry=Cookies.get("room"+i);if(entry==null||entry=="undefined"){return}msges=entry.split(";");if(entry.length==0){return}one=document.createElement("div");one.classList.add("col");one.classList.add("s12");two=document.createElement("a");two.setAttribute("onclick","goToPin('"+msges[3]+"',"+msges[2]+",`"+entry+"`);");two.classList.add("valign-wrapper");threeone=document.createElement("div");threeone.classList.add("col");threeone.classList.add("s1");threeone.classList.add("center-align");threeone.style="padding:0px";threetwo=document.createElement("div");threetwo.innerHTML=getBuildingNames()[idToInfos(msges[3]).buildingNo];threetwo.style="line-height: 1.1";threetwo.classList.add("col");threetwo.classList.add("s5");threetwo.classList.add("center-align");threethree=document.createElement("div");threethree.style="line-height: 1.1";threethree.classList.add("col");threethree.classList.add("s6");threethree.innerHTML=msges[0];icon=document.createElement("i");icon.classList.add("material-icons");icon.innerHTML="search";threeone.appendChild(icon);two.appendChild(threeone);two.appendChild(threetwo);two.appendChild(threethree);one.appendChild(two);document.getElementById("history_results").appendChild(one)}}function removeHistory(){for(i=0;i<5;i++){Cookies.set("room"+i,"undefined")}isCardEmpty()}function setMarkers(){if(map==null){return}if(map.getMapTypeId()[0]==0){maxZoom=9}else{maxZoom=8}if(map.getZoom()<maxZoom-1){hideAllMarkers(true,map.getBounds());return}else{hideAllMarkers(false,map.getBounds())}};